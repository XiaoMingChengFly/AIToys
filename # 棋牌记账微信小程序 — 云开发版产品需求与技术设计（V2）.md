# 棋牌记账微信小程序 — 云开发版产品需求与技术设计（V2）

## 一、项目目标

开发一个支持多人实时共享的棋牌记账微信小程序：

* 不限制人数与规则
* 仅记录输赢与转账流水
* 自动计算每人余额
* 多人同时打开同一牌局可共同记账
* 数据存储在微信云开发数据库，永久保存

---

## 二、技术架构

### 前端

* 微信小程序原生（WXML / WXSS / JS）

### 后端（使用微信云开发 CloudBase）

* 云数据库（NoSQL）
* 云函数
* 用户身份（openid）

小程序启动时：

* 初始化云开发环境
* 获取当前用户 openid

---

## 三、核心功能

### 1. 牌局管理

#### 创建牌局

输入：

* 牌局名称

自动记录：

* 创建时间
* 创建人 openid

#### 牌局列表

首页显示：

* 我创建的牌局
* 最近参与的牌局

---

### 2. 玩家管理

在牌局内：

* 添加玩家（输入名称）
* 默认余额 = 0

显示：

* 玩家名称
* 当前余额（实时计算）

---

### 3. 记账功能（核心）

操作：

* 选择付款人
* 选择收款人
* 输入金额

生成记录：

* 一条流水写入数据库
* 自动更新双方余额

---

### 4. 流水记录

每个牌局必须保留全部历史流水：

字段：

* 时间
* 付款人
* 收款人
* 金额

按时间排序展示。

---

### 5. 实时数据更新

当有人新增记账：

* 其他人刷新后可看到最新余额与记录

（后续可扩展实时监听）

---

## 四、数据库设计

### game 集合

```
{
  _id
  name
  createTime
  ownerOpenId
}
```

---

### player 集合

```
{
  _id
  gameId
  name
  balance
}
```

---

### record 集合

```
{
  _id
  gameId
  fromPlayerId
  toPlayerId
  amount
  time
}
```

---

## 五、页面结构

### 首页

pages/index/index

* 查看牌局列表
* 创建牌局

---

### 牌局详情

pages/game/game

* 玩家列表
* 余额展示
* 新增记账
* 进入流水页面

---

### 流水页面

pages/records/records

* 查看历史记录

---

## 六、项目目录结构要求

生成完整小程序项目：

```
app.json
app.js
app.wxss

pages/
  index/
  game/
  records/

cloudfunctions/
  login/
  addRecord/
  updateBalance/

utils/
```

---

## 七、MVP必须实现

* 云开发初始化
* 创建牌局
* 添加玩家
* 记账写入云数据库
* 自动更新余额
* 查看历史流水

---

## 八、Codex开发任务

Codex应：

* 初始化微信云开发项目
* 创建数据库访问逻辑
* 编写云函数（获取 openid、写入流水、更新余额）
* 生成可直接在微信开发者工具运行的完整工程
* 提供清晰、可扩展代码结构
